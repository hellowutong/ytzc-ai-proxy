# AI Gateway - Complete Docker Compose Configuration
# For manual testing and development deployment
#
# Usage:
#   Start:      docker-compose up -d
#   View logs:   docker-compose logs -f
#   Stop:       docker-compose down
#   Clean:      docker-compose down -v  # Also removes volumes

version: '3.8'

services:
  # ============================================
  # INFRASTRUCTURE SERVICES
  # ============================================

  # MongoDB - Primary data persistence
  mongodb:
    image: mongo:7.0
    container_name: ai-gateway-mongodb
    restart: unless-stopped
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-ai_gateway}
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongodb/init:/docker-entrypoint-initdb.d:ro
      - ./docker/mongodb/mongod.conf:/etc/mongod.conf:ro
    command: ["mongod", "--config", "/etc/mongod.conf"]
    networks:
      - ai-gateway-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Redis - Cache and session storage
  redis:
    image: redis:7.2-alpine
    container_name: ai-gateway-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - ai-gateway-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Qdrant - Vector database for embeddings
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: ai-gateway-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "6334:6334"
    environment:
      QDRANT__LOG_LEVEL: ${QDRANT_LOG_LEVEL:-INFO}
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - ai-gateway-network
    # Health check disabled - Qdrant container doesn't have curl/wget
    # Service starts successfully, manual verification available at port 6333

  # ============================================
  # APPLICATION SERVICES
  # ============================================

  # Backend - FastAPI Application
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.11
    container_name: ai-gateway-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      # Database connections (service names as hostnames)
      - MONGODB_URI=mongodb://${MONGODB_ROOT_USERNAME:-admin}:${MONGODB_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DATABASE:-ai_gateway}?authSource=admin
      - REDIS_URI=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}

      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}

      # Workers (production only)
      - WORKERS=${WORKERS:-1}
    volumes:
      # Mount config for hot reload in development
      - ./config.yml:/app/config.yml:rw
      - app_logs:/app/logs
      - app_data:/app/data
    networks:
      - ai-gateway-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/live", "||", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health/live')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # Frontend - Vue.js UI
  wei-ui:
    build:
      context: ./wei-ui
      dockerfile: Dockerfile
    container_name: ai-gateway-wei-ui
    restart: unless-stopped
    ports:
      - "${UI_PORT:-5175}:80"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8000}
    networks:
      - ai-gateway-network
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # OPTIONAL SERVICES
  # ============================================

  # Nginx - Reverse Proxy (optional, for production)
  nginx:
    image: nginx:alpine
    container_name: ai-gateway-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./docker/nginx/logs:/var/log/nginx
      - /etc/localtime:/etc/localtime:ro
    networks:
      - ai-gateway-network
    depends_on:
      - app
      - wei-ui
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - production

# ============================================
# VOLUMES
# ============================================
volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  qdrant_data:
    driver: local
  app_logs:
    driver: local
  app_data:
    driver: local

# ============================================
# NETWORKS
# ============================================
networks:
  ai-gateway-network:
    driver: bridge
    name: ai-gateway-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

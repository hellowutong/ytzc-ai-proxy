import{A as W,i as g}from"./index-DgeW9NR8.js";import{u as G}from"./models-CjJxZ9ep.js";const Z=W("chat",()=>{const c=g([]),e=g(null),p=g(!1),l=g({temperature:.7,max_tokens:2e3,stream:!0,knowledge_enabled:!0,web_search_enabled:!1,dark_theme:!0,code_highlight:!0,show_thinking:!1});async function J(){var t;try{const n=await(await fetch("/admin/ai/v1/conversations")).json();if(n.code===200){const a=new Set,r=n.data.items.filter(o=>a.has(o.id)?(console.warn("去除重复对话:",o.id),!1):(a.add(o.id),!0)),u=(t=e.value)==null?void 0:t.id;if(c.value=r,u&&e.value){const o=c.value.find(v=>v.id===u);o?e.value=o:e.value=null}}}catch(s){console.error("Failed to fetch conversations:",s)}}async function N(t){try{const n=await(await fetch("/admin/ai/v1/conversations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t})})).json();if(n.code===200){const a=c.value.findIndex(u=>u.id===n.data.id);if(a!==-1)return e.value=c.value[a],c.value[a];const r={id:n.data.id,model:t,messages:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return c.value.unshift(r),e.value=r,r}}catch(s){console.error("Failed to create conversation:",s)}return null}function F(t){e.value=t}async function P(t,s){var a,r,u,o,v,S,w,y,_,O,C,I,D,k;const n={role:"user",content:t,timestamp:new Date().toISOString()};(a=e.value)==null||a.messages.push(n);try{p.value=!0;const m=G(),d=m.models.find(i=>i.name===s),z=(d==null?void 0:d.proxy_key)||"",h=await fetch("/proxy/ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`},body:JSON.stringify({model:s,messages:((r=e.value)==null?void 0:r.messages)||[],conversation_id:((u=e.value)==null?void 0:u.id)||null,temperature:l.value.temperature,max_tokens:l.value.max_tokens})});if((h.headers.get("content-type")||"").includes("application/json")){const i=await h.json();if(i.error){const f={role:"assistant",content:i.error.message||"抱歉，处理您的请求时出现了错误。",timestamp:new Date().toISOString()};(o=e.value)==null||o.messages.push(f)}else{const f={role:"assistant",content:((w=(S=(v=i.choices)==null?void 0:v[0])==null?void 0:S.message)==null?void 0:w.content)||"",timestamp:new Date().toISOString()};(y=e.value)==null||y.messages.push(f)}}else{const i=(_=h.body)==null?void 0:_.getReader(),f=new TextDecoder;let x="";const T={role:"assistant",content:"",timestamp:new Date().toISOString()};for((O=e.value)==null||O.messages.push(T);i;){const{done:B,value:E}=await i.read();if(B)break;const K=f.decode(E).split(`
`);for(const b of K)if(b.startsWith("data: ")){const j=b.slice(6);if(j==="[DONE]")continue;try{const M=(D=(I=(C=JSON.parse(j).choices)==null?void 0:C[0])==null?void 0:I.delta)==null?void 0:D.content;M&&(x+=M,T.content=x)}catch{}}}}e.value&&(e.value.updated_at=new Date().toISOString()),await m.fetchModels()}catch(m){console.error("Failed to send message:",m);const d={role:"assistant",content:"抱歉，发生了错误，请稍后重试。",timestamp:new Date().toISOString()};(k=e.value)==null||k.messages.push(d)}finally{p.value=!1}}async function R(t){if(t)try{if(!t.id){console.error("尝试保存没有ID的对话");return}const s=await fetch(`/admin/ai/v1/conversations/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t.messages,updated_at:t.updated_at})});if(!s.ok){console.warn(`保存对话失败: ${s.status}`);return}(await s.json()).code===200&&(console.log("对话保存成功"),e.value&&(e.value.updated_at=new Date().toISOString()))}catch(s){console.warn("保存对话失败:",s)}}function $(){p.value=!1}function A(t){l.value={...l.value,...t}}function q(){e.value&&(e.value.messages=[])}return{conversations:c,currentConversation:e,isStreaming:p,settings:l,fetchConversations:J,createConversation:N,setCurrentConversation:F,sendMessage:P,saveConversation:R,stopStreaming:$,updateSettings:A,clearCurrentConversation:q}});export{Z as u};
//# sourceMappingURL=chat-CXlrgbd5.js.map
